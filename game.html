<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/x-icon" href="Icon.PNG">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HEART CLASH: CHHAY ULTIMATE PRO ELITE</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Outfit:wght@300;600;900&family=Space+Grotesk:wght@300;700&display=swap');

        :root {
            --bf: #00d2ff;
            --gf: #ff4d6d;
            --gold: #ffd700;
            --bg: #02020a;
            --card: rgba(10, 10, 25, 0.95);
            --accent: #7000ff;
            --danger: #ff003c;
            
        }

        * { 
            box-sizing: border-box; 
            touch-action: none; 
            user-select: none; 
            -webkit-tap-highlight-color: transparent;
        }
        .floating-link {
            position: fixed;
            bottom: 25px;
            right: 25px;
            width: 60px;
            height: 60px;
            background: var(--primary-pink);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            text-decoration: none;
            box-shadow: 0 5px 15px rgba(255, 77, 109, 0.4);
            z-index: 9999;
            animation: pulse 2s infinite;
            font-size: 1.5rem;
        }

        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 77, 109, 0.7); }
            70% { transform: scale(1.1); box-shadow: 0 0 0 15px rgba(255, 77, 109, 0); }
            100% { transform: scale(1); }
        }

        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            background: var(--bg); color: white; 
            font-family: 'Outfit', sans-serif; overflow: hidden; 
        }

        canvas { display: block; position: fixed; inset: 0; z-index: 1; }

        /* --- PRELOADER & LOADING LOGIC --- */
        #loading-overlay {
            position: fixed; inset: 0; z-index: 9999;
            background: radial-gradient(circle at center, #0a0a20 0%, #000 100%);
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            transition: opacity 1.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .chhay-brand {
            font-family: 'Press Start 2P'; font-size: 2.5rem;
            background: linear-gradient(to right, var(--bf), #fff, var(--gf));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 0 15px rgba(0,210,255,0.5));
            animation: brand-pulse 2s infinite ease-in-out;
            margin-bottom: 20px;
        }

        @keyframes brand-pulse {
            0% { transform: scale(0.95); opacity: 0.8; }
            50% { transform: scale(1.05); opacity: 1; filter: drop-shadow(0 0 30px var(--gf)); }
            100% { transform: scale(0.95); opacity: 0.8; }
        }

        .loader-bar-container {
            width: 300px; height: 4px; background: rgba(255,255,255,0.1);
            border-radius: 10px; overflow: hidden; position: relative;
        }
        .loader-fill {
            position: absolute; left: 0; top: 0; height: 100%;
            width: 0%; background: var(--bf);
            box-shadow: 0 0 15px var(--bf);
            animation: fill-up 2.5s forwards;
        }
        @keyframes fill-up { to { width: 100%; } }

        /* --- UI LAYER SYSTEMS --- */
        .ui-layer { 
            position: fixed; inset: 0; z-index: 1000; 
            display: flex; flex-direction: column; 
            justify-content: center; align-items: center;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(10px);
            transition: 0.6s all ease-in-out;
        }
        .hidden { opacity: 0 !important; pointer-events: none !important; transform: scale(1.1); }

        .panel-glass {
            background: var(--card); padding: 60px; border-radius: 40px;
            border: 1px solid rgba(255,255,255,0.08); width: 90%; max-width: 650px;
            text-align: center; box-shadow: 0 50px 100px rgba(0,0,0,0.9);
            position: relative; overflow: hidden;
        }

        /* --- BUTTON ARCHITECTURE --- */
        .btn-core {
            width: 100%; padding: 25px; margin-top: 20px;
            background: linear-gradient(135deg, var(--gf) 0%, #ff8fa3 100%);
            border: none; border-radius: 20px; color: white;
            font-family: 'Press Start 2P'; font-size: 12px;
            cursor: pointer; box-shadow: 0 8px 0 #9b2d41;
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            text-transform: uppercase; letter-spacing: 2px;
        }
        .btn-core:hover { transform: translateY(-2px); filter: brightness(1.1); }
        .btn-core:active { transform: translateY(4px); box-shadow: 0 2px 0 #9b2d41; }

        .btn-secondary {
            background: #222; box-shadow: 0 8px 0 #000;
        }

        .btn-wipe-history {
            background: linear-gradient(135deg, #ff416c, #ff4b2b);
            margin-top: 40px; font-size: 10px; box-shadow: 0 6px 0 #a30000;
        }

        /* --- MODE SELECTOR GRID --- */
        .mode-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin: 40px 0; }
        .mode-card {
            background: rgba(255,255,255,0.02); border: 2px solid rgba(255,255,255,0.05);
            padding: 25px 15px; border-radius: 24px; cursor: pointer; transition: 0.4s;
        }
        .mode-card:hover { background: rgba(255,255,255,0.08); transform: translateY(-5px); }
        .mode-card.selected { border-color: var(--bf); background: rgba(0, 210, 255, 0.1); box-shadow: 0 0 30px rgba(0,210,255,0.2); }
        .mode-card h3 { margin: 0; font-size: 14px; font-weight: 900; }
        .mode-card p { margin: 10px 0 0 0; font-size: 10px; opacity: 0.5; font-family: 'Press Start 2P'; }

        /* --- HUD (HEADS UP DISPLAY) --- */
        #game-hud {
            position: fixed; top: 0; width: 100%; padding: 40px;
            display: flex; justify-content: space-between; align-items: flex-start;
            z-index: 500; pointer-events: none; transition: 0.5s opacity;
        }
        .hud-module {
            background: rgba(5, 5, 15, 0.9); padding: 25px; border-radius: 30px;
            min-width: 220px; border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(15px);
        }
        .score-val { font-family: 'Press Start 2P'; font-size: 28px; margin: 10px 0; }
        .hp-hearts { font-size: 24px; letter-spacing: 5px; filter: drop-shadow(0 0 5px var(--gf)); }
        
        .timer-module {
            text-align: center; background: none; border: none;
        }
        #timer-display { font-family: 'Press Start 2P'; font-size: 4rem; color: #fff; text-shadow: 0 0 20px rgba(255,255,255,0.3); }

        /* --- VICTORY PODIUM SYSTEM --- */
        #victory-podium {
            position: fixed; inset: 0; z-index: 5000;
            display: none; flex-direction: column;
            justify-content: center; align-items: center;
            background: rgba(0,0,0,0.95); text-align: center;
            animation: fadeIn 0.5s ease-out;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .champion-frame {
            width: 220px; height: 220px; border-radius: 50%;
            border: 12px solid var(--gold); box-shadow: 0 0 80px var(--gold);
            margin-bottom: 30px; overflow: hidden; position: relative;
        }
        .champion-frame img { width: 100%; height: 100%; object-fit: cover; }
        
        .tongue-emoji { font-size: 80px; margin: 20px 0; animation: bounce 1s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }

        /* --- SIDEBAR LOGS --- */
        #sidebar-history {
            position: fixed; top: 0; right: -450px; width: 420px; height: 100%;
            background: var(--card); z-index: 2000; border-left: 4px solid var(--accent);
            padding: 50px 30px; transition: 0.7s cubic-bezier(0.19, 1, 0.22, 1);
            overflow-y: auto; box-shadow: -20px 0 50px rgba(0,0,0,0.5);
        }
        #sidebar-history.active { right: 0; }
        .log-entry {
            background: rgba(255,255,255,0.02); padding: 25px; border-radius: 25px;
            margin-bottom: 20px; border-left: 6px solid var(--bf);
            transition: 0.3s;
        }
        .log-entry:hover { background: rgba(255,255,255,0.05); }

        /* --- MOBILE CONTROLS --- */
        .dpad { position: fixed; bottom: 50px; display: grid; grid-template-areas: ". u ." "l . r" ". d ."; gap: 20px; z-index: 1000; }
        .d-btn {
            width: 90px; height: 90px; background: rgba(255,255,255,0.05);
            border: 2px solid rgba(255,255,255,0.1); border-radius: 30px;
            display: flex; align-items: center; justify-content: center;
            font-size: 32px; color: white; backdrop-filter: blur(12px);
            transition: 0.1s;
        }
        .d-btn:active { background: white; color: black; transform: scale(0.9); }

        /* --- SCROLLBAR --- */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--gf); border-radius: 10px; }
    </style>
</head>
<body>
     <a href="index.html" class="floating-link" title="Another Secret">
        üè†
    </a>

    <div id="loading-overlay">
        <div class="chhay-brand">CREATE BY CHHAY</div>
        <div class="loader-bar-container">
            <div class="loader-fill"></div>
        </div>
        <p style="margin-top:20px; letter-spacing:4px; font-size:10px; opacity:0.6;">INITIALIZING ENGINE v4.0</p>
    </div>

    <div id="victory-podium">
        <div class="champion-frame">
            <img id="winner-portrait" src="" alt="Champion">
        </div>
        <h1 id="victory-announcement" style="font-family:'Press Start 2P'; color:var(--gold); font-size:28px;"></h1>
        <div class="tongue-emoji">üòõ</div>
        <p style="font-family:'Press Start 2P'; font-size:10px; opacity:0.5; margin-top:30px;">RESTARTING SIMULATION...</p>
    </div>

    <div id="game-hud" class="hidden">
        <div class="hud-module" style="border-left: 8px solid var(--bf);">
            <div style="font-weight:900; color:var(--bf); font-size:12px;">P1: BOYFRIEND</div>
            <div id="p1-score" class="score-val">0</div>
            <div id="p1-hp" class="hp-hearts">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
        </div>

        <div class="timer-module">
            <div id="timer-display">60</div>
            <div style="font-size:10px; font-weight:900; letter-spacing:3px; opacity:0.5;">TIME REMAINING</div>
        </div>

        <div class="hud-module" style="border-right: 8px solid var(--gf); text-align:right;">
            <div style="font-weight:900; color:var(--gf); font-size:12px;">P2: GIRLFRIEND</div>
            <div id="p2-score" class="score-val">0</div>
            <div id="p2-hp" class="hp-hearts">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
        </div>
    </div>

    <div id="main-menu" class="ui-layer">
        <div class="panel-glass">
            <h1 style="font-family:'Press Start 2P'; font-size:2.2rem; margin:0;">HEART <span style="color:var(--gf)">CLASH</span></h1>
            <p style="letter-spacing:8px; font-size:11px; margin:15px 0 45px; color:var(--bf); font-weight:900;">ULTIMATE PRO EDITION</p>

            <div class="mode-grid">
                <div class="mode-card selected" id="mode-blitz" onclick="gameControl.selectMode(60, 3, 'mode-blitz')">
                    <h3>BLITZ</h3>
                    <p>60S / 3HP</p>
                </div>
                <div class="mode-card" id="mode-std" onclick="gameControl.selectMode(120, 5, 'mode-std')">
                    <h3>STANDARD</h3>
                    <p>120S / 5HP</p>
                </div>
                <div class="mode-card" id="mode-pro" onclick="gameControl.selectMode(300, 10, 'mode-pro')">
                    <h3>PRO</h3>
                    <p>300S / 10HP</p>
                </div>
            </div>

            <button class="btn-core" onclick="gameControl.initiateBattle()">START BATTLE</button>
            <button class="btn-core btn-secondary" onclick="uiManager.toggleHistory()">VIEW RECORDS</button>
        </div>
    </div>

    <div id="sidebar-history">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:40px;">
            <h2 style="font-family:'Press Start 2P'; font-size:18px; color:var(--gold); margin:0;">BATTLE LOGS</h2>
            <button onclick="uiManager.toggleHistory()" style="background:none; border:none; color:white; font-size:24px; cursor:pointer;">&times;</button>
        </div>

        <div id="battle-stats-summary" style="background:rgba(0,0,0,0.3); padding:20px; border-radius:20px; display:flex; justify-content:space-around; margin-bottom:30px;">
            <div style="text-align:center;"><div style="color:var(--bf); font-weight:900;">BF WINS</div><div id="stat-bf-wins" style="font-family:'Press Start 2P'; margin-top:10px;">0</div></div>
            <div style="text-align:center;"><div style="color:var(--gf); font-weight:900;">GF WINS</div><div id="stat-gf-wins" style="font-family:'Press Start 2P'; margin-top:10px;">0</div></div>
        </div>

        <div id="history-list-container">
            </div>

        <button class="btn-core btn-wipe-history" onclick="uiManager.wipeRecords()">WIPE ALL HISTORY</button>
        <button class="btn-core btn-secondary" onclick="uiManager.toggleHistory()" style="margin-top:20px;">BACK TO MENU</button>
    </div>

    <div class="dpad hidden" id="dpad-left" style="left:50px;">
        <div class="d-btn" style="grid-area:u" onpointerdown="inputHandler.setKey('bf','u',1)" onpointerup="inputHandler.setKey('bf','u',0)">W</div>
        <div class="d-btn" style="grid-area:l" onpointerdown="inputHandler.setKey('bf','l',1)" onpointerup="inputHandler.setKey('bf','l',0)">A</div>
        <div class="d-btn" style="grid-area:r" onpointerdown="inputHandler.setKey('bf','r',1)" onpointerup="inputHandler.setKey('bf','r',0)">D</div>
        <div class="d-btn" style="grid-area:d" onpointerdown="inputHandler.setKey('bf','d',1)" onpointerup="inputHandler.setKey('bf','d',0)">S</div>
    </div>

    <div class="dpad hidden" id="dpad-right" style="right:50px;">
        <div class="d-btn" style="grid-area:u" onpointerdown="inputHandler.setKey('gf','u',1)" onpointerup="inputHandler.setKey('gf','u',0)">‚ñ≤</div>
        <div class="d-btn" style="grid-area:l" onpointerdown="inputHandler.setKey('gf','l',1)" onpointerup="inputHandler.setKey('gf','l',0)">‚óÄ</div>
        <div class="d-btn" style="grid-area:r" onpointerdown="inputHandler.setKey('gf','r',1)" onpointerup="inputHandler.setKey('gf','r',0)">‚ñ∂</div>
        <div class="d-btn" style="grid-area:d" onpointerdown="inputHandler.setKey('gf','d',1)" onpointerup="inputHandler.setKey('gf','d',0)">‚ñº</div>
    </div>

    <canvas id="mainCanvas"></canvas>

    <script>
        /**
         * AUDIO ENGINE
         * Uses Web Audio API to synthesize retro game sounds
         */
        const SoundEngine = (() => {
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            
            const createTone = (freq, type, duration, volume = 0.1) => {
                if(audioCtx.state === 'suspended') audioCtx.resume();
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                
                oscillator.type = type;
                oscillator.frequency.setValueAtTime(freq, audioCtx.currentTime);
                
                gainNode.gain.setValueAtTime(volume, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + duration);
                
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                
                oscillator.start();
                oscillator.stop(audioCtx.currentTime + duration);
            };

            return {
                playCollect: () => createTone(880, 'sine', 0.2),
                playHurt: () => createTone(150, 'sawtooth', 0.4, 0.2),
                playSelect: () => createTone(440, 'square', 0.05),
                playVictory: () => {
                    createTone(523, 'sine', 0.2);
                    setTimeout(() => createTone(659, 'sine', 0.2), 150);
                    setTimeout(() => createTone(783, 'sine', 0.4), 300);
                }
            };
        })();

        /**
         * UI & DATA MANAGEMENT
         * Handles localStorage and DOM manipulation
         */
        const uiManager = {
            storageKey: 'chhay_battle_v4_history',
            
            init() {
                this.checkSession();
                this.updateHistoryUI();
            },

           checkSession() {
                const overlay = document.getElementById('loading-overlay');
                // Force hide after 1 second no matter what
                setTimeout(() => {
                    overlay.style.display = 'none';
                    overlay.style.pointerEvents = 'none'; // Ensures you can click through it
                }, 1000);
            },

            toggleHistory() {
                SoundEngine.playSelect();
                document.getElementById('sidebar-history').classList.toggle('active');
            },

            saveResult(winner, p1Score, p2Score) {
                const history = JSON.parse(localStorage.getItem(this.storageKey) || '[]');
                const newEntry = {
                    id: Date.now(),
                    winner: winner,
                    p1: p1Score,
                    p2: p2Score,
                    timestamp: new Date().toLocaleString()
                };
                history.unshift(newEntry);
                localStorage.setItem(this.storageKey, JSON.stringify(history.slice(0, 50)));
                this.updateHistoryUI();
            },

            updateHistoryUI() {
                const container = document.getElementById('history-list-container');
                const history = JSON.parse(localStorage.getItem(this.storageKey) || '[]');
                
                const bfWins = history.filter(h => h.winner === 'BOYFRIEND').length;
                const gfWins = history.filter(h => h.winner === 'GIRLFRIEND').length;
                
                document.getElementById('stat-bf-wins').innerText = bfWins;
                document.getElementById('stat-gf-wins').innerText = gfWins;

                if(history.length === 0) {
                    container.innerHTML = `<p style="text-align:center; opacity:0.3; margin-top:50px;">NO BATTLES RECORDED</p>`;
                    return;
                }

                container.innerHTML = history.map(entry => `
                    <div class="log-entry" style="border-color: ${entry.winner === 'BOYFRIEND' ? 'var(--bf)' : 'var(--gf)'}">
                        <div style="font-size:9px; opacity:0.5; margin-bottom:10px;">${entry.timestamp}</div>
                        <div style="font-family:'Press Start 2P'; font-size:12px; color:var(--gold);">WINNER: ${entry.winner}</div>
                        <div style="margin-top:10px; font-weight:700;">BF: ${entry.p1} PTS | GF: ${entry.p2} PTS</div>
                    </div>
                `).join('');
            },

            wipeRecords() {
                if(confirm("DANGER: This will delete all your battle records forever. Proceed?")) {
                    localStorage.removeItem(this.storageKey);
                    SoundEngine.playHurt();
                    this.updateHistoryUI();
                    alert("History Wiped Successfully.");
                }
            }
        };

        /**
         * INPUT HANDLER
         * Supports Keyboard and Multi-touch DPAD
         */
        const inputHandler = {
            keys: {
                bf: { u: 0, d: 0, l: 0, r: 0 },
                gf: { u: 0, d: 0, l: 0, r: 0 }
            },
            
            init() {
                window.addEventListener('keydown', (e) => this.update(e, 1));
                window.addEventListener('keyup', (e) => this.update(e, 0));
            },

            setKey(player, dir, val) {
                this.keys[player][dir] = val;
            },

            update(e, state) {
                const k = e.key.toLowerCase();
                // Boyfriend
                if(k === 'w') this.keys.bf.u = state;
                if(k === 's') this.keys.bf.d = state;
                if(k === 'a') this.keys.bf.l = state;
                if(k === 'd') this.keys.bf.r = state;
                // Girlfriend
                if(e.key === 'ArrowUp') this.keys.gf.u = state;
                if(e.key === 'ArrowDown') this.keys.gf.d = state;
                if(e.key === 'ArrowLeft') this.keys.gf.l = state;
                if(e.key === 'ArrowRight') this.keys.gf.r = state;
            }
        };

        /**
         * PARTICLE ENGINE
         * Advanced visual effects for hits and explosions
         */
        class Particle {
            constructor(x, y, color) {
                this.x = x; this.y = y;
                this.vx = (Math.random() - 0.5) * 15;
                this.vy = (Math.random() - 0.5) * 15;
                this.life = 1.0;
                this.decay = 0.015 + Math.random() * 0.02;
                this.color = color;
                this.size = 2 + Math.random() * 4;
            }
            update() {
                this.x += this.vx; this.y += this.vy;
                this.vy += 0.2; // Gravity
                this.life -= this.decay;
            }
            draw(ctx) {
                ctx.globalAlpha = this.life;
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        /**
         * MATCH INSTANCE ENGINE
         * Manages the actual game loop logic
         */
        class MatchInstance {
            constructor(ctx, w, h, config) {
                this.ctx = ctx; this.w = w; this.h = h;
                this.active = true;
                this.time = config.time;
                this.maxHp = config.hp;
                
                this.p1 = this.createChar(w * 0.2, h/2, 'bf.jpg', varColor('--bf'));
                this.p2 = this.createChar(w * 0.8, h/2, 'gf.jpg', varColor('--gf'));
                
                this.items = [];
                this.particles = [];
                this.spawnTimer = 0;
                
                this.startTimer();
            }

            createChar(x, y, img, color) {
                const char = {
                    x, y, color, score: 0, hp: this.maxHp, sz: 100, 
                    img: new Image(), loaded: false
                };
                char.img.onload = () => char.loaded = true;
                char.img.src = img;
                return char;
            }

            startTimer() {
                this.clock = setInterval(() => {
                    if(this.time > 0) {
                        this.time--;
                        document.getElementById('timer-display').innerText = this.time;
                    } else {
                        this.end();
                    }
                }, 1000);
            }

            spawn() {
                const types = [
                    { t: 'HEART', s: '‚ù§Ô∏è', val: 100, color: '#ff4d6d' },
                    { t: 'BOMB', s: 'üí£', val: 0, color: '#ffffff' },
                    { t: 'STAR', s: '‚≠ê', val: 500, color: '#ffd700' }
                ];
                const type = types[Math.floor(Math.random() * types.length)];
                this.items.push({
                    x: Math.random() * (this.w - 100) + 50,
                    y: -50,
                    vy: 3 + Math.random() * 3, // Lower numbers = slower falling (easier to see)
                    ...type
                });

            }

            update(keys) {
                const speed = 12;
                // Move Player 1
                if(keys.bf.u) this.p1.y -= speed; if(keys.bf.d) this.p1.y += speed;
                if(keys.bf.l) this.p1.x -= speed; if(keys.bf.r) this.p1.x += speed;
                // Move Player 2
                if(keys.gf.u) this.p2.y -= speed; if(keys.gf.d) this.p2.y += speed;
                if(keys.gf.l) this.p2.x -= speed; if(keys.gf.r) this.p2.x += speed;

                // Bound Check
                [this.p1, this.p2].forEach(p => {
                    p.x = Math.max(0, Math.min(this.w - p.sz, p.x));
                    p.y = Math.max(0, Math.min(this.h - p.sz, p.y));
                });

                // Spawn Items
                if(++this.spawnTimer > 25) {
                    this.spawn();
                    this.spawnTimer = 0;
                }

                // Process Items
                this.items.forEach((it, idx) => {
                    it.y += it.vy;
                    [this.p1, this.p2].forEach(p => {
                        if(this.checkHit(p, it)) {
                            this.resolveHit(p, it);
                            this.items.splice(idx, 1);
                        }
                    });
                    if(it.y > this.h) this.items.splice(idx, 1);
                });

                // Particles
                this.particles.forEach((p, i) => {
                    p.update();
                    if(p.life <= 0) this.particles.splice(i, 1);
                });

                this.syncHUD();
                if(this.p1.hp <= 0 || this.p2.hp <= 0) this.end();
            }

            checkHit(p, it) {
                return it.x > p.x && it.x < p.x + p.sz && it.y > p.y && it.y < p.y + p.sz;
            }

            resolveHit(p, it) {
                if(it.t === 'BOMB') {
                    p.hp--;
                    SoundEngine.playHurt();
                    this.explode(it.x, it.y, '#ff0000', 30);
                } else {
                    p.score += it.val;
                    SoundEngine.playCollect();
                    this.explode(it.x, it.y, it.color, 15);
                }
            }

            explode(x, y, color, count) {
                for(let i=0; i<count; i++) this.particles.push(new Particle(x, y, color));
            }

            syncHUD() {
                document.getElementById('p1-score').innerText = this.p1.score;
                document.getElementById('p2-score').innerText = this.p2.score;
                document.getElementById('p1-hp').innerText = "‚ù§Ô∏è".repeat(Math.max(0, this.p1.hp));
                document.getElementById('p2-hp').innerText = "‚ù§Ô∏è".repeat(Math.max(0, this.p2.hp));
            }

           draw() {
                // 1. Clear and reset transparency
                this.ctx.clearRect(0, 0, this.w, this.h);
                this.ctx.globalAlpha = 1.0; 

                // 2. Draw Background Stars (Low opacity is okay here)
                this.ctx.save();
                this.ctx.fillStyle = "rgba(255,255,255,0.1)";
                for(let i=0; i<50; i++) {
                    this.ctx.fillRect(Math.sin(Date.now()*0.001+i)*this.w, (i*20)%this.h, 2, 2);
                }
                this.ctx.restore();

                // 3. Draw Items (FORCE FULL OPACITY)
                this.items.forEach(it => {
                    this.ctx.save();
                    this.ctx.globalAlpha = 1.0; // <--- THIS FIXES THE FADING
                    this.ctx.font = "bold 60px Arial"; 
                    this.ctx.shadowBlur = 15;
                    this.ctx.shadowColor = "white"; 
                    this.ctx.textAlign = "center";
                    this.ctx.textBaseline = "middle";
                    this.ctx.fillText(it.s, it.x, it.y);
                    this.ctx.restore();
                });

                // 4. Draw Players (FORCE FULL OPACITY)
                [this.p1, this.p2].forEach(p => {
                    this.ctx.save();
                    this.ctx.globalAlpha = 1.0; // <--- THIS FIXES THE FADING
                    this.ctx.shadowBlur = 40;
                    this.ctx.shadowColor = p.color;
                    this.ctx.strokeStyle = p.color;
                    this.ctx.lineWidth = 6;
                    
                    this.ctx.beginPath();
                    this.ctx.arc(p.x + p.sz/2, p.y + p.sz/2, p.sz/2, 0, Math.PI*2);
                    this.ctx.stroke();
                    this.ctx.clip();
                    
                    if(p.loaded) {
                        this.ctx.drawImage(p.img, p.x, p.y, p.sz, p.sz);
                    } else {
                        this.ctx.fillStyle = p.color;
                        this.ctx.fill();
                    }
                    this.ctx.restore();
                });

                // 5. Draw Particles (These are allowed to fade)
                this.particles.forEach(p => p.draw(this.ctx));
                
                // Final Reset to ensure nothing else stays transparent
                this.ctx.globalAlpha = 1.0;
            }
            end() {
                if(!this.active) return;
                this.active = false;
                clearInterval(this.clock);
                
                let winner = "DRAW";
                if(this.p1.hp <= 0) winner = "GIRLFRIEND";
                else if(this.p2.hp <= 0) winner = "BOYFRIEND";
                else {
                    if(this.p1.score > this.p2.score) winner = "BOYFRIEND";
                    if(this.p2.score > this.p1.score) winner = "GIRLFRIEND";
                }

                gameControl.showVictory(winner, this.p1.score, this.p2.score);
            }
        }

        /**
         * MASTER GAME CONTROL
         * High-level state management
         */
        const gameControl = {
            state: 'MENU',
            config: { time: 60, hp: 3 },
            
            init() {
                this.canvas = document.getElementById('mainCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.resize();
                window.addEventListener('resize', () => this.resize());
                
                inputHandler.init();
                uiManager.init();
                
                this.gameLoop();
            },

            resize() {
                this.w = this.canvas.width = window.innerWidth;
                this.h = this.canvas.height = window.innerHeight;
            },

            selectMode(time, hp, id) {
                SoundEngine.playSelect();
                this.config = { time, hp };
                document.querySelectorAll('.mode-card').forEach(c => c.classList.remove('selected'));
                document.getElementById(id).classList.add('selected');
            },

            initiateBattle() {
                SoundEngine.playSelect();
                
                // Completely remove the menu and overlay from view
                document.getElementById('main-menu').style.display = 'none';
                document.getElementById('loading-overlay').style.display = 'none';
                
                // Show the HUD
                document.getElementById('game-hud').classList.remove('hidden');
                document.querySelectorAll('.dpad').forEach(d => d.classList.remove('hidden'));
                
                this.currentMatch = new MatchInstance(this.ctx, this.w, this.h, this.config);
                this.state = 'BATTLE';
            },

            showVictory(winner, s1, s2) {
                this.state = 'FINISH';
                uiManager.saveResult(winner, s1, s2);
                SoundEngine.playVictory();
                
                const podium = document.getElementById('victory-podium');
                const portrait = document.getElementById('winner-portrait');
                const text = document.getElementById('victory-announcement');
                
                portrait.src = winner === 'BOYFRIEND' ? 'bf.jpg' : 'gf.jpg';
                text.innerText = winner + " WINS";
                
                podium.style.display = 'flex';
                setTimeout(() => location.reload(), 5000);
            },

            gameLoop() {
            if(this.state === 'BATTLE' && this.currentMatch) {
                // Only draw the match logic during battle
                this.currentMatch.update(inputHandler.keys);
                this.currentMatch.draw();
            } else if(this.state === 'MENU') {
                // Only draw the menu background when NOT in battle
                this.ctx.fillStyle = '#02020a';
                this.ctx.fillRect(0,0,this.w,this.h);
                // ... rest of menu star logic
            }
            requestAnimationFrame(() => this.gameLoop());
        }
        };

        // Helper: Get CSS Variable Color
        function varColor(name) {
            return getComputedStyle(document.documentElement).getPropertyValue(name).trim();
        }

        // ENTRY POINT
        window.onload = () => gameControl.init();

    </script>
</body>
</html>